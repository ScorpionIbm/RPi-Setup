#!/bin/bash -ex
#FQ_Codel
#############SETUP VARIABLES###############################################################################################

PATH=/bin:/usr/bin:/sbin:/usr/sbin

#Files
	status=/mnt/dietpi_userdata/downloads/limits_status
	log=/mnt/dietpi_userdata/downloads/script.log

#Interface
	iface=eth0
#	ifb=ifb0

#Priority
	High_Prio=0
	Con_Prio=1
	UL_Prio=1
	DL_Prio=3
	User_Prio=3
	Guest_Prio=7
	Local_Prio=7
	Low_Prio=7

#Bandwidth
	Local=100
	Download=4500
	Upload=900
	Guest=400
	Games_DOWN=4500
	Games_UP=4500

#HTB
	#quant="quantum 1474"

#FQ_CODEL
	quantum="quantum 300"
	quantum_UP="noecn limit 1000"

#PFIFO
	limit=1000

#RATES

	#Download
	DL=$[Download]Kbit
	DL_Ceil=$[Download]Kbit
	#Upload
	UL=$[Upload]Kbit
	UL_Ceil=$[Upload]Kbit
	#User Speed
	User_DL=$[Download/6]Kbit
	User_DL_Ceil=$[Download/4]Kbit
	#Guest Speed
	Guest_DL=$[Guest]Kbit
	Guest_DL_Ceil=$[Guest]Kbit
	#Games Speed
	Games_DL=$[Games_DOWN]Kbit
	Games_DL_Ceil=$[Games_DOWN]Kbit
	Games_UL=$[Games_UP]Kbit
	Games_UL_Ceil=$[Games_UP]Kbit
	#Local Speed
	Local_DL=$[Local]Mbit
	Local_Ceil=$[Local]Mbit
#############SETUP VARIABLES###############################################################################################

start() {
#########IFB################
#modprobe ifb
#ip link set dev $ifb up
#tc qdisc add dev $iface ingress handle ffff:
#	tc filter add dev $iface parent ffff: protocol ip u32 match u32 0 0 action mirred egress redirect dev $ifb flowid ffff:1
#
#tc qdisc add dev $ifb root handle 3: htb default 30
#	tc class add dev $ifb parent 3:3 classid 3:30 htb rate $Local_DL ceil $Local_Ceil
#		tc qdisc add dev $ifb parent 3:30 fq_codel $quantum
#########IFB################


#############SETUP BASE CONNECTION#########################################################################################
tc qdisc add dev $iface root handle 1: htb default 100
#############SETUP BASE CONNECTION#########################################################################################

#############SETUP CLASSES#################################################################################################

####INTERNET
	tc class add dev $iface parent 1: classid 1:1 htb rate $DL ceil $DL_Ceil prio $DL_Prio $quant
		##############ISLAM##########################
		tc class add dev $iface parent 1:1 classid 1:2 htb rate $User_DL ceil $User_DL_Ceil prio $User_Prio $quant
			tc qdisc add dev $iface parent 1:2 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:2 sfq perturb 10
		##############HAMDY##########################
		tc class add dev $iface parent 1:1 classid 1:3 htb rate $User_DL ceil $User_DL_Ceil prio $User_Prio $quant
			tc qdisc add dev $iface parent 1:3 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:3 sfq perturb 10
		##############AHMED##########################
		tc class add dev $iface parent 1:1 classid 1:4 htb rate $User_DL ceil $User_DL_Ceil prio $User_Prio $quant
			tc qdisc add dev $iface parent 1:4 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:4 sfq perturb 10
		##############MARAM##########################
		tc class add dev $iface parent 1:1 classid 1:5 htb rate $User_DL ceil $User_DL_Ceil prio $User_Prio $quant
			tc qdisc add dev $iface parent 1:5 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:5 sfq perturb 10
		##############MAMA###########################
		tc class add dev $iface parent 1:1 classid 1:6 htb rate $User_DL ceil $User_DL prio $Low_Prio $quant
			tc qdisc add dev $iface parent 1:6 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:6 sfq perturb 10
		##############BABA###########################
		tc class add dev $iface parent 1:1 classid 1:7 htb rate $User_DL ceil $User_DL prio $Low_Prio $quant
			tc qdisc add dev $iface parent 1:7 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:7 sfq perturb 10
		##############GUESTS##########################
		tc class add dev $iface parent 1:1 classid 1:8 htb rate $Guest_DL ceil $Guest_DL_Ceil prio $Guest_Prio $quant
			tc qdisc add dev $iface parent 1:8 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:8 sfq perturb 10
		###############GAMES_DOWN#####################
		tc class add dev $iface parent 1:1 classid 1:21 htb rate $Games_DL ceil $Games_DL_Ceil prio $High_Prio $quant
			tc qdisc add dev $iface parent 1:21 pfifo limit $limit
#			tc qdisc add dev $iface parent 1:21 sfq perturb 10
		###############GAMES_UP#######################
		tc class add dev $iface parent 1:1 classid 1:20 htb rate $Games_UL ceil $Games_UL_Ceil prio $High_Prio $quant
			tc qdisc add dev $iface parent 1:20 pfifo limit $limit
#			tc qdisc add dev $iface parent 1:20 sfq perturb 10
		##############UPLOAD#########################
		tc class add dev $iface parent 1:1 classid 1:100 htb rate $UL ceil $UL_Ceil prio $UL_Prio $quant
			tc qdisc add dev $iface parent 1:100 fq_codel $quantum
#			tc qdisc add dev $iface parent 1:100 sfq perturb 10
	#CONNECTION_INITIATION
	tc class add dev $iface parent 1: classid 1:10 htb rate $UL ceil $UL_Ceil prio $High_Prio $quant
		tc qdisc add dev $iface parent 1:10 pfifo limit $limit
#		tc qdisc add dev $iface parent 1:10 sfq perturb 10
#	#ROUTER
#	tc class add dev $iface parent 1: classid 1:11 htb rate $Local_DL ceil $Local_Ceil prio $High_Prio $quant
#		tc qdisc add dev $iface parent 1:11 fq_codel $quantum
##		tc qdisc add dev $iface parent 1:11 sfq perturb 10
####LOCAL
	#LOCAL
	tc class add dev $iface parent 1: classid 1:9 htb rate $Local_DL ceil $Local_Ceil prio $Local_Prio
		tc qdisc add dev $iface parent 1:9 fq_codel $quantum
#		tc qdisc add dev $iface parent 1:9 sfq perturb 10
#	#SSH_TO
#	tc class add dev $iface parent 1: classid 1:30 htb rate $Local_DL ceil $Local_Ceil prio $Local_Prio
#		tc qdisc add dev $iface parent 1:30 fq_codel $quantum
##		tc qdisc add dev $iface parent 1:30 sfq perturb 10
#	#SSH_FROM
#	tc class add dev $iface parent 1: classid 1:31 htb rate $Local_DL ceil $Local_Ceil prio $Local_Prio
#		tc qdisc add dev $iface parent 1:31 fq_codel $quantum
##		tc qdisc add dev $iface parent 1:31 sfq perturb 10

#############SETUP CLASSES#################################################################################################

#############SETUP IPTABLES################################################################################################

#SSH
#iptables -t mangle -A POSTROUTING -p tcp -m tcp -d 192.168.1.5 --dport 22 -j CLASSIFY --set-class 1:30
#iptables -t mangle -A POSTROUTING -p tcp -m tcp -d 192.168.1.5 --dport 22 -j RETURN
#iptables -t mangle -A POSTROUTING -p tcp -m tcp -s 192.168.1.5 --sport 22 -j CLASSIFY --set-class 1:31
#iptables -t mangle -A POSTROUTING -p tcp -m tcp -s 192.168.1.5 --sport 22 -j RETURN

# ! -d 192.168.1.0/24
# ! -d 192.168.1.0/24
# ! -d 192.168.1.0/24
# ! -d 192.168.1.0/24
#
#
# ! -s 192.168.1.0/24
# ! -s 192.168.1.0/24
# ! -s 192.168.1.0/24
# ! -s 192.168.1.0/24

##############GAME PRIORITIZE################
	#GAMES_UP
	#LOL
	iptables -t mangle -A POSTROUTING -p udp -m multiport --dports 5000:5500,8088 -j CONNMARK --set-mark 20
	iptables -t mangle -A POSTROUTING -p tcp -m multiport --dports 8393:8400,2099,5223,5222,8088 -j CONNMARK --set-mark 20
	iptables -t mangle -A POSTROUTING -m connmark --mark 20 -j CLASSIFY --set-class 1:20
	iptables -t mangle -A POSTROUTING -m connmark --mark 20 -j RETURN
	#GAMES_DOWN
	#LOL
	iptables -t mangle -A POSTROUTING -p udp -m multiport --sports 5000:5500,8088 -j CONNMARK --set-mark 21
	iptables -t mangle -A POSTROUTING -p tcp -m multiport --sports 8393:8400,2099,5223,5222,8088 -j CONNMARK --set-mark 21
	iptables -t mangle -A POSTROUTING -m connmark --mark 21 -j CLASSIFY --set-class 1:21
	iptables -t mangle -A POSTROUTING -m connmark --mark 21 -j RETURN
###############TCP CONNECTION START###########
iptables -t mangle -A POSTROUTING -p icmp -j CLASSIFY --set-class 1:10
iptables -t mangle -A POSTROUTING -p icmp -j RETURN
iptables -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j CLASSIFY --set-class 1:10
iptables -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j RETURN
#iptables -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK ACK -j CLASSIFY --set-class 1:10
#iptables -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK ACK -j RETURN
#iptables -t mangle -A POSTROUTING -m tos --tos Minimize-Delay -j CLASSIFY --set-class 1:10
#iptables -t mangle -A POSTROUTING -m tos --tos Minimize-Delay -j RETURN
###############ROUTER#########################
#iptables -t mangle -A POSTROUTING -p tcp -s 192.168.1.1/32 -j CLASSIFY --set-class 1:11
#iptables -t mangle -A POSTROUTING -p tcp -s 192.168.1.1/32 -j RETURN
#iptables -t mangle -A POSTROUTING -p tcp -d 192.168.1.1/32 -j CLASSIFY --set-class 1:11
#iptables -t mangle -A POSTROUTING -p tcp -d 192.168.1.1/32 -j RETURN
###############GUESTS#########################
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.80-192.168.1.254 -j CLASSIFY --set-class 1:8
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.80-192.168.1.254 -j RETURN
iptables -t mangle -A POSTROUTING -o $iface -m iprange --src-range 192.168.1.80-192.168.1.254 -j CLASSIFY --set-class 1:8
iptables -t mangle -A POSTROUTING -o $iface -m iprange --src-range 192.168.1.80-192.168.1.254 -j RETURN
##############LOCAL##########################
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.2-192.168.1.254 --src-range 192.168.1.2-192.168.1.254 -j CLASSIFY --set-class 1:9
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.2-192.168.1.254 --src-range 192.168.1.2-192.168.1.254 -j RETURN
##############ISLAM##########################
#iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.20-192.168.1.29 -j CONNMARK --set-mark 2
#iptables -t mangle -A POSTROUTING -o $iface -m connmark --mark 2 -j CLASSIFY --set-class 1:2
#iptables -t mangle -A POSTROUTING -o $iface -m connmark --mark 2 -j RETURN
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.20-192.168.1.29 -j CLASSIFY --set-class 1:2
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.20-192.168.1.29 -j RETURN
##############HAMDY##########################
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.30-192.168.1.39 -j CLASSIFY --set-class 1:3
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.30-192.168.1.39 -j RETURN
##############AHMED##########################
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.40-192.168.1.49 -j CLASSIFY --set-class 1:4
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.40-192.168.1.49 -j RETURN
##############MARAM##########################
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.50-192.168.1.59 -j CLASSIFY --set-class 1:5
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.50-192.168.1.59 -j RETURN
##############MAMA###########################
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.60-192.168.1.69 -j CLASSIFY --set-class 1:6
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.60-192.168.1.69 -j RETURN
##############BABA###########################
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.70-192.168.1.79 -j CLASSIFY --set-class 1:7
iptables -t mangle -A POSTROUTING -o $iface -m iprange --dst-range 192.168.1.70-192.168.1.79 -j RETURN
#############SETUP ROUTING FILTERS#########################################################################################
}

stop() {
#	ip link set dev $ifb down
#	tc qdisc del dev $ifb root
#	tc qdisc del dev $ifb ingress
	tc qdisc del dev $iface root
#	tc qdisc del dev $iface ingress
    iptables -t mangle -F
}

case "$1" in
    'start')
            start 2>&1 | tee $log
			if [ `echo "${PIPESTATUS[@]}" | tr -s ' ' + | bc` -ne 0 ]
			then
				echo Failed to start limits please restart or check script for errors | tee $status
			else
				echo Limits running | tee $status
			fi
            ;;
    'stop')
            stop 2>&1 | tee $log
			if [ `echo "${PIPESTATUS[@]}" | tr -s ' ' + | bc` -ne 0 ]
			then 
				echo Already stopped / Failed to stop limits  | tee $status
			else 
				echo Limits Stopped | tee $status
			fi
            ;;
    'status')
            echo $(<$status)
            ;;
    'restart')
            limits stop ; echo "Sleeping..."; sleep 2 ;
            limits start
            ;;
    *)
            echo
            echo "Usage: $0 { start | stop | restart | status}"
            echo
            exit 1
            ;;
esac

exit 0
