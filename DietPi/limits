#!/bin/bash -ex
#FQ_Codel
#############SETUP VARIABLES###############################################################################################

PATH=/bin:/usr/bin:/sbin:/usr/sbin

#Files
	status=/mnt/dietpi_userdata/downloads/limits_status
	log=/mnt/dietpi_userdata/downloads/script.log

#Interface
	iface=eth0

#Priority
	High_Prio=0
	Con_Prio=1
	UL_Prio=1
	DL_Prio=3
	User_Prio=3
	Guest_Prio=7
	Local_Prio=7
	Low_Prio=7

#Bandwidth
	Local=100
	Download=$2
	Upload=900
	Guest=300
	Games_DOWN=4500
	Games_UP=4500

#HTB
	#quant="quantum 1474"

#FQ_CODEL
	fq_codel="fq_codel quantum 300"

#PFIFO
	pfifo="pfifo limit 1000"

#RATES

	#Download
	DL=$[Download]Kbit
	DL_Ceil=$[Download]Kbit
	#Upload
	UL=$[Upload]Kbit
	UL_Ceil=$[Upload]Kbit
	#User Speed
	User_DL=$[Download/6]Kbit
	User_DL_Ceil=$[Download/4]Kbit
	#Guest Speed
	Guest_DL=1Kbit
	Guest_DL_Ceil=$[Guest]Kbit
	#Games Speed
	Games_DL=$[Games_DOWN]Kbit
	Games_DL_Ceil=$[Games_DOWN]Kbit
	Games_UL=$[Games_UP]Kbit
	Games_UL_Ceil=$[Games_UP]Kbit
	#Local Speed
	Local_DL=$[Local]Mbit
	Local_Ceil=$[Local]Mbit
#############SETUP VARIABLES###############################################################################################

user_limit() {
	tc class add dev $iface parent 1:1 classid 1:$1 htb rate $2 ceil $3 prio $4 $5
		tc qdisc add dev $iface parent 1:$1 $6
}
IPT_range() {
	iptables -t mangle -A POSTROUTING -o $iface -m iprange $1 -j CLASSIFY --set-class 1:$2
	iptables -t mangle -A POSTROUTING -o $iface -m iprange $1 -j RETURN
}
tc_setup() {
	#############SETUP BASE CONNECTION#########################################################################################
	tc qdisc add dev $iface root handle 1: htb default 100
	#############SETUP BASE CONNECTION#########################################################################################

	#############SETUP CLASSES#################################################################################################

	####INTERNET
		tc class add dev $iface parent 1: classid 1:1 htb rate $DL ceil $DL_Ceil prio $DL_Prio $quant
			##############ISLAM##########################
			user_limit 2 $User_DL $User_DL_Ceil $User_Prio "$quant" "$fq_codel"
			##############HAMDY##########################
			user_limit 3 $User_DL $User_DL_Ceil $User_Prio "$quant" "$fq_codel"
			##############AHMED##########################
			user_limit 4 $User_DL $User_DL_Ceil $User_Prio "$quant" "$fq_codel"
			##############MARAM##########################
			user_limit 5 $User_DL $User_DL_Ceil $User_Prio "$quant" "$fq_codel"
			##############MAMA###########################
			user_limit 6 $User_DL $User_DL $Low_Prio "$quant" "$fq_codel"
			##############BABA###########################
			user_limit 7 $User_DL $User_DL $Low_Prio "$quant" "$fq_codel"
			##############GUESTS##########################
			user_limit 8 $Guest_DL $Guest_DL_Ceil $Guest_Prio "$quant" "$fq_codel"
			###############GAMES_DOWN#####################
			user_limit 21 $Games_DL $Games_DL_Ceil $High_Prio "$quant" "$pfifo"
			###############GAMES_UP#######################
			user_limit 20 $Games_UL $Games_UL_Ceil $High_Prio "$quant" "$pfifo"
			##############UPLOAD#########################
			user_limit 100 $UL $UL_Ceil $UL_Prio "$quant" "$pfifo"
		#CONNECTION_INITIATION
		user_limit 10 $UL $UL_Ceil $UL_Prio "$quant" "$pfifo"
	####LOCAL
		#LOCAL
		user_limit 9 $Local_DL $Local_Ceil $Local_Prio "$quant" "$fq_codel"
	#############SETUP CLASSES#################################################################################################
}
IPT_setup() {
	#############SETUP IPTABLES################################################################################################

	##############GAME PRIORITIZE################
		#GAMES_UP
		#LOL
		iptables -t mangle -A POSTROUTING -p udp -m multiport --dports 5000:5500,8088 -j CONNMARK --set-mark 20
		iptables -t mangle -A POSTROUTING -p tcp -m multiport --dports 8393:8400,2099,5223,5222,8088 -j CONNMARK --set-mark 20
		iptables -t mangle -A POSTROUTING -m connmark --mark 20 -j CLASSIFY --set-class 1:20
		iptables -t mangle -A POSTROUTING -m connmark --mark 20 -j RETURN
		#GAMES_DOWN
		#LOL
		iptables -t mangle -A POSTROUTING -p udp -m multiport --sports 5000:5500,8088 -j CONNMARK --set-mark 21
		iptables -t mangle -A POSTROUTING -p tcp -m multiport --sports 8393:8400,2099,5223,5222,8088 -j CONNMARK --set-mark 21
		iptables -t mangle -A POSTROUTING -m connmark --mark 21 -j CLASSIFY --set-class 1:21
		iptables -t mangle -A POSTROUTING -m connmark --mark 21 -j RETURN
	###############TCP CONNECTION START###########
	iptables -t mangle -A POSTROUTING -p icmp -j CLASSIFY --set-class 1:10
	iptables -t mangle -A POSTROUTING -p icmp -j RETURN
	iptables -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j CLASSIFY --set-class 1:10
	iptables -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j RETURN
	##############NEW_PI#########################
	IPT_range "--dst-range 192.168.1.18-192.168.1.19" 1
	##############GUESTS#########################
	IPT_range "--dst-range 192.168.1.80-192.168.1.254" 8
	IPT_range "--src-range 192.168.1.80-192.168.1.254" 8
	##############LOCAL##########################
	IPT_range "--dst-range 192.168.1.2-192.168.1.254 --src-range 192.168.1.2-192.168.1.254" 9
	##############ISLAM##########################
	IPT_range "--dst-range 192.168.1.20-192.168.1.29" 2
	##############HAMDY##########################
	IPT_range "--dst-range 192.168.1.30-192.168.1.39" 3
	##############AHMED##########################
	IPT_range "--dst-range 192.168.1.40-192.168.1.49" 4
	##############MARAM##########################
	IPT_range "--dst-range 192.168.1.50-192.168.1.59" 5
	##############MAMA###########################
	IPT_range "--dst-range 192.168.1.60-192.168.1.69" 6
	##############BABA###########################
	IPT_range "--dst-range 192.168.1.70-192.168.1.79" 7
	#############SETUP ROUTING FILTERS#########################################################################################
}

start() {
tc_setup
IPT_setup
}

stop() {
	tc qdisc del dev $iface root
    iptables -t mangle -F
}

case "$1" in
    'start')
            start 2>&1 | tee $log
			if [ `echo "${PIPESTATUS[@]}" | tr -s ' ' + | bc` -ne 0 ]
			then
				echo Failed to start limits please restart or check script for errors | tee $status
			else
				echo Limits running | tee $status
			fi
            ;;
    'stop')
            stop 2>&1 | tee $log
			if [ `echo "${PIPESTATUS[@]}" | tr -s ' ' + | bc` -ne 0 ]
			then 
				echo Already stopped / Failed to stop limits  | tee $status
			else 
				echo Limits Stopped | tee $status
			fi
            ;;
    'status')
            echo $(<$status)
            ;;
    'restart')
            limits stop ; echo "Sleeping..."; sleep 2 ;
            limits start $2
            ;;
    *)
            echo
            echo "Usage: $0 { start | stop | restart | status}"
            echo
            exit 1
            ;;
esac

exit 0