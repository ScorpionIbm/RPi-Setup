#!/bin/bash 

set -e

#############SETUP VARIABLES###############################################################################################

#IPTABLES
IPT=/sbin/iptables
#TC
TC=/sbin/tc
#Priority
Con_Prio=0
UL_Prio=0
DL_Prio=3
Usr_Prio=5
Gst_Prio=7
Local_Prio=7
#Bandwidth
Local_DL=100Mbit
Local_Ceil=100Mbit
DL1=1800
DL2=4300
UL1=700
Gst1=400
#FQ_CODEL
quantum=300
#Download
DL=$[DL1]Kbit
DL_Ceil=$[DL2]Kbit
#Upload
UL=$[UL1]Kbit
UL_Ceil=$[UL1]Kbit
#User Speed
Usr_DL=$[DL2/6]Kbit
Usr_DL_Ceil=$[DL2/6]Kbit
#Guest Speed
Gst_DL=$[Gst1]Kbit
Gst_DL_Ceil=$[Gst1]Kbit
#############SETUP VARIABLES###############################################################################################

start() {
#############SETUP BASE CONNECTION#########################################################################################
$TC qdisc add dev eth0 root handle 1: htb default 100
#############SETUP BASE CONNECTION#########################################################################################

#############SETUP CLASSES#################################################################################################

	#INTERNET
	$TC class add dev eth0 parent 1: classid 1:1 htb rate $DL ceil $DL_Ceil prio $DL_Prio
		##############UPLOAD#########################
		$TC class add dev eth0 parent 1:1 classid 1:100 htb rate $UL ceil $UL_Ceil prio $UL_Prio
			$TC qdisc add dev eth0 parent 1:100 fq_codel quantum $quantum
		##############ISLAM##########################
		$TC class add dev eth0 parent 1:1 classid 1:2 htb rate $Usr_DL ceil $Usr_DL_Ceil prio $Usr_Prio
			$TC qdisc add dev eth0 parent 1:2 fq_codel quantum $quantum
		##############HAMDY##########################
		$TC class add dev eth0 parent 1:1 classid 1:3 htb rate $Usr_DL ceil $Usr_DL_Ceil prio $Usr_Prio
			$TC qdisc add dev eth0 parent 1:3 fq_codel quantum $quantum
		##############AHMED##########################
		$TC class add dev eth0 parent 1:1 classid 1:4 htb rate $Usr_DL ceil $Usr_DL_Ceil prio $Usr_Prio
			$TC qdisc add dev eth0 parent 1:4 fq_codel quantum $quantum
		##############MARAM##########################
		$TC class add dev eth0 parent 1:1 classid 1:5 htb rate $Usr_DL ceil $Usr_DL_Ceil prio $Usr_Prio
			$TC qdisc add dev eth0 parent 1:5 fq_codel quantum $quantum
		##############MAMA###########################
		$TC class add dev eth0 parent 1:1 classid 1:6 htb rate $Usr_DL ceil $Usr_DL_Ceil prio $Usr_Prio
			$TC qdisc add dev eth0 parent 1:6 fq_codel quantum $quantum
		##############BABA###########################
		$TC class add dev eth0 parent 1:1 classid 1:7 htb rate $Usr_DL ceil $Usr_DL_Ceil prio $Usr_Prio
			$TC qdisc add dev eth0 parent 1:7 fq_codel quantum $quantum
		##############GUESTS##########################
		$TC class add dev eth0 parent 1:1 classid 1:8 htb rate $Gst_DL ceil $Gst_DL_Ceil prio $Gst_Prio
			$TC qdisc add dev eth0 parent 1:8 fq_codel quantum $quantum
	#LOCAL
	$TC class add dev eth0 parent 1: classid 1:9 htb rate $Local_DL ceil $Local_Ceil prio $Local_Prio
		$TC qdisc add dev eth0 parent 1:9 fq_codel quantum $quantum
	#CONNECTION_INITIATION
	$TC class add dev eth0 parent 1: classid 1:10 htb rate $UL ceil $UL_Ceil prio $Con_Prio
		$TC qdisc add dev eth0 parent 1:10 fq_codel quantum $quantum

#############SETUP CLASSES#################################################################################################

#############SETUP ROUTING FILTERS#########################################################################################

##############UPLOAD#########################

##############TCP CONNECTION START###########
$IPT -t mangle -A POSTROUTING -p icmp -j CLASSIFY --set-class 1:10
$IPT -t mangle -A POSTROUTING -p icmp -j RETURN
$IPT -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j CLASSIFY --set-class 1:10
$IPT -t mangle -A POSTROUTING -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j RETURN
$IPT -t mangle -A POSTROUTING -m tos --tos Minimize-Delay -j CLASSIFY --set-class 1:10
$IPT -t mangle -A POSTROUTING -m tos --tos Minimize-Delay -j RETURN
##############GUESTS#########################
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.80-192.168.1.254 -j CLASSIFY --set-class 1:8
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --src-range 192.168.1.80-192.168.1.254 -j CLASSIFY --set-class 1:8
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --src-range 192.168.1.80-192.168.1.254 -j RETURN
##############LOCAL##########################
$IPT -t mangle -A POSTROUTING -o eth0 -s 192.168.1.0/24 -d 192.168.1.0/24 -j CLASSIFY --set-class 1:9
$IPT -t mangle -A POSTROUTING -o eth0 -s 192.168.1.0/24 -d 192.168.1.0/24 -j RETURN
##############ISLAM##########################
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.20-192.168.1.29 -j CLASSIFY --set-class 1:2
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.20-192.168.1.29 -j RETURN
##############HAMDY##########################
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.30-192.168.1.39 -j CLASSIFY --set-class 1:3
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.30-192.168.1.39 -j RETURN
##############AHMED##########################
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.40-192.168.1.49 -j CLASSIFY --set-class 1:4
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.40-192.168.1.49 -j RETURN
##############MARAM##########################
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.50-192.168.1.69 -j CLASSIFY --set-class 1:5
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.50-192.168.1.69 -j RETURN
##############MAMA###########################
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.60-192.168.1.69 -j CLASSIFY --set-class 1:6
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.60-192.168.1.69 -j RETURN
##############BABA###########################
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.70-192.168.1.79 -j CLASSIFY --set-class 1:7
$IPT -t mangle -A POSTROUTING -o eth0 -m iprange --dst-range 192.168.1.70-192.168.1.79 -j RETURN
#############SETUP ROUTING FILTERS#########################################################################################
}

stop() {
    $IPT -t mangle -F
	$TC qdisc del dev eth0 root
}

case "$1" in
    'start')
            start 2>&1 | tee /mnt/dietpi_userdata/downloads/script.log
			if [ `echo "${PIPESTATUS[@]}" | tr -s ' ' + | bc` -ne 0 ]
			then echo Failed to start limits please restart or check script for errors> /mnt/dietpi_userdata/downloads/limits_status
			else echo Limits running > /mnt/dietpi_userdata/downloads/limits_status
			fi
            ;;
    'stop')
            stop 2>&1 | tee /mnt/dietpi_userdata/downloads/script.log
			if [ `echo "${PIPESTATUS[@]}" | tr -s ' ' + | bc` -ne 0 ]
			then echo Already stopped / Failed to stop limits > /mnt/dietpi_userdata/downloads/limits_status
			else echo Limits Stopped > /mnt/dietpi_userdata/downloads/limits_status
			fi
            ;;
    'status')
            echo $(</mnt/dietpi_userdata/downloads/limits_status)
            ;;
    'restart')
            limits stop ; echo "Sleeping..."; sleep 2 ;
            limits start
            ;;
    *)
            echo
            echo "Usage: $0 { start | stop | restart | status}"
            echo
            exit 1
            ;;
esac

exit 0
